services:
  # Node 1 - Primary node that builds, creates CTE, and runs tests
  cte-node1:
    image: iowarp/iowarp:latest
    container_name: cte-distributed-node1
    hostname: iowarp-node1
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.10
    volumes:
      - ../../../:/content-transfer-engine
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
      - ./chimaera_config.yaml:/etc/iowarp/chimaera_config.yaml:ro
      - cte-install:/usr/local
      - hdd1-storage:/mnt/hdd1
    environment:
      - NODE_ID=1
      - NODE_IP=172.26.0.10
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /content-transfer-engine
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 1: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 1: Cleaning /usr/local to avoid conflicts...' &&
        rm -rf /usr/local/games /usr/local/etc &&
        echo 'Node 1: Loading spack environment...' &&
        export SPACK_ROOT=/root/spack &&
        source /root/spack/share/spack/setup-env.sh &&
        spack load iowarp-runtime &&
        echo 'Node 1: Spack environment loaded successfully' &&
        echo '========================================' &&
        echo 'Node 1: Building Content Transfer Engine' &&
        echo '========================================' &&
        cd /content-transfer-engine &&
        rm -rf build-docker &&
        echo 'Node 1: Running cmake with debug-docker preset...' &&
        cmake --preset debug-docker 2>&1 | tee /tmp/cmake.log || (echo 'CMAKE FAILED:' && cat /tmp/cmake.log && exit 1) &&
        echo 'Node 1: Checking if build-docker directory was created...' &&
        ls -la build-docker/ &&
        echo 'Node 1: CMake complete. Building CTE and tests...' &&
        cmake --build build-docker --config Debug -j8 2>&1 | tee /tmp/build.log; test $${PIPESTATUS[0]} -eq 0 || (echo 'BUILD FAILED:' && cat /tmp/build.log && exit 1) &&
        echo 'Node 1: Build complete. Running make install...' &&
        cd build-docker &&
        make install 2>&1 | tee /tmp/install.log; test $${PIPESTATUS[0]} -eq 0 || (echo 'INSTALL FAILED:' && cat /tmp/install.log && exit 1) &&
        cd /content-transfer-engine &&
        echo 'Node 1: Verifying launch_cte installation...' &&
        ls -la /usr/local/bin/launch_cte &&
        echo '========================================' &&
        echo 'Node 1: Build and install complete' &&
        echo '========================================' &&
        echo 'Node 1: Starting IOWarp runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export CHI_SERVER_CONF=/etc/iowarp/chimaera_config.yaml &&
        chimaera_start_runtime &
        RUNTIME_PID=$$! &&
        echo \"Node 1: Runtime started (PID $$RUNTIME_PID)\" &&
        sleep 5 &&
        echo 'Node 1: Creating storage directories...' &&
        mkdir -p /mnt/hdd1 &&
        echo 'Node 1: Waiting for all nodes to be ready...' &&
        sleep 10 &&
        echo '========================================' &&
        echo 'Node 1: Launching CTE' &&
        echo '========================================' &&
        export CTE_CONFIG_FILE=/etc/iowarp/cte_config.yaml &&
        /usr/local/bin/launch_cte &&
        echo 'Node 1: CTE launched successfully' &&
        echo '========================================' &&
        echo 'Node 1: Running distributed unit tests' &&
        echo '========================================' &&
        test_core_functionality_dist &&
        echo '========================================' &&
        echo 'Node 1: Tests complete' &&
        echo '========================================' &&
        tail -f /dev/null
      "

  # Node 2 - Secondary node
  cte-node2:
    image: iowarp/iowarp:latest
    container_name: cte-distributed-node2
    hostname: iowarp-node2
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.11
    volumes:
      - ../../../:/content-transfer-engine
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
      - ./chimaera_config.yaml:/etc/iowarp/chimaera_config.yaml:ro
      - cte-install:/usr/local
      - hdd2-storage:/mnt/hdd2
    environment:
      - NODE_ID=2
      - NODE_IP=172.26.0.11
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /content-transfer-engine
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 2: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 2: Waiting for build to complete...' &&
        while [ ! -f /usr/local/bin/launch_cte ]; do
          sleep 2
          echo 'Node 2: Still waiting for binaries...'
        done &&
        echo 'Node 2: Binaries found!' &&
        echo 'Node 2: Loading spack environment...' &&
        export SPACK_ROOT=/root/spack &&
        source /root/spack/share/spack/setup-env.sh &&
        spack load iowarp-runtime &&
        echo 'Node 2: Spack environment loaded successfully' &&
        echo '========================================' &&
        echo 'Node 2: Setting up storage and runtime' &&
        echo '========================================' &&
        mkdir -p /mnt/hdd2 &&
        echo 'Node 2: Starting IOWarp runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export CHI_SERVER_CONF=/etc/iowarp/chimaera_config.yaml &&
        chimaera_start_runtime &
        RUNTIME_PID=$$! &&
        echo \"Node 2: Runtime started (PID $$RUNTIME_PID)\" &&
        echo '========================================' &&
        echo 'Node 2: Ready. Waiting for tests...' &&
        echo '========================================' &&
        tail -f /dev/null
      "

  # Node 3 - Secondary node
  cte-node3:
    image: iowarp/iowarp:latest
    container_name: cte-distributed-node3
    hostname: iowarp-node3
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.12
    volumes:
      - ../../../:/content-transfer-engine
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
      - ./chimaera_config.yaml:/etc/iowarp/chimaera_config.yaml:ro
      - cte-install:/usr/local
      - hdd3-storage:/mnt/hdd3
    environment:
      - NODE_ID=3
      - NODE_IP=172.26.0.12
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /content-transfer-engine
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 3: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 3: Waiting for build to complete...' &&
        while [ ! -f /usr/local/bin/launch_cte ]; do
          sleep 2
          echo 'Node 3: Still waiting for binaries...'
        done &&
        echo 'Node 3: Binaries found!' &&
        echo 'Node 3: Loading spack environment...' &&
        export SPACK_ROOT=/root/spack &&
        source /root/spack/share/spack/setup-env.sh &&
        spack load iowarp-runtime &&
        echo 'Node 3: Spack environment loaded successfully' &&
        echo '========================================' &&
        echo 'Node 3: Setting up storage and runtime' &&
        echo '========================================' &&
        mkdir -p /mnt/hdd3 &&
        echo 'Node 3: Starting IOWarp runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export CHI_SERVER_CONF=/etc/iowarp/chimaera_config.yaml &&
        chimaera_start_runtime &
        RUNTIME_PID=$$! &&
        echo \"Node 3: Runtime started (PID $$RUNTIME_PID)\" &&
        echo '========================================' &&
        echo 'Node 3: Ready. Waiting for tests...' &&
        echo '========================================' &&
        tail -f /dev/null
      "

  # Node 4 - Secondary node
  cte-node4:
    image: iowarp/iowarp:latest
    container_name: cte-distributed-node4
    hostname: iowarp-node4
    networks:
      cte-cluster:
        ipv4_address: 172.26.0.13
    volumes:
      - ../../../:/content-transfer-engine
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
      - ./chimaera_config.yaml:/etc/iowarp/chimaera_config.yaml:ro
      - cte-install:/usr/local
      - hdd4-storage:/mnt/hdd4
    environment:
      - NODE_ID=4
      - NODE_IP=172.26.0.13
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /content-transfer-engine
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 4: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 4: Waiting for build to complete...' &&
        while [ ! -f /usr/local/bin/launch_cte ]; do
          sleep 2
          echo 'Node 4: Still waiting for binaries...'
        done &&
        echo 'Node 4: Binaries found!' &&
        echo 'Node 4: Loading spack environment...' &&
        export SPACK_ROOT=/root/spack &&
        source /root/spack/share/spack/setup-env.sh &&
        spack load iowarp-runtime &&
        echo 'Node 4: Spack environment loaded successfully' &&
        echo '========================================' &&
        echo 'Node 4: Setting up storage and runtime' &&
        echo '========================================' &&
        mkdir -p /mnt/hdd4 &&
        echo 'Node 4: Starting IOWarp runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export CHI_SERVER_CONF=/etc/iowarp/chimaera_config.yaml &&
        chimaera_start_runtime &
        RUNTIME_PID=$$! &&
        echo \"Node 4: Runtime started (PID $$RUNTIME_PID)\" &&
        echo '========================================' &&
        echo 'Node 4: Ready. Waiting for tests...' &&
        echo '========================================' &&
        tail -f /dev/null
      "

volumes:
  cte-install:
    driver: local
  hdd1-storage:
    driver: local
  hdd2-storage:
    driver: local
  hdd3-storage:
    driver: local
  hdd4-storage:
    driver: local

networks:
  cte-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16
